{"ts":1373773440381,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"// Get the lib\r\nvar irc = require(\"irc\");\r\nvar request = require('request');\r\nvar moment = require('moment');\r\nvar parseString = require('xml2js').parseString;\r\nvar googleapis = require('googleapis');\r\nvar db = require('node-persist');\r\n\r\n\r\n//Google API key\r\nvar key = 'AIzaSyDPlGenbEo8T-sbeNHx_shvJSRCwOpCESc';\r\n\r\nvar ip = 'http://198.211.99.242:8020/';\r\nvar chan = '#SonicRadioboom';\r\n\r\nvar now = new moment();\r\ndb.initSync();\r\nif (!db.getItem('ElectricErger'.substring(0,12))) {\r\n    db.setItem('ElectricErger'.substring(0,12), now);\r\n}\r\nif (!db.getItem('linaea'.substring(0,12))) {\r\n    db.setItem('linaea'.substring(0,12), now);\r\n}\r\nvar current;\r\nrequest(ip+'stats?sid=1', function (error, response, body) {\r\n    if (!error && response.statusCode == 200) {\r\n        parseString(body, function (err, result) {\r\n            current = result;\r\n        });\r\n    }\r\n});\r\n\r\n// Create the configuration\r\nvar config = {\r\n    channels: [chan],\r\n\tserver: \"irc.canternet.org\",\r\n\tbotName: \"Sonia\",\r\n    floodProtection: true,\r\n};\r\n\r\nvar notify = true;\r\n\r\n// Create the bot name\r\nvar sonia = new irc.Client(config.server, config.botName, {\r\n    channels: config.channels\r\n});\r\n\r\nsonia.addListener('message', function (from, to, message) {\r\n    // console.log(from + ' => ' + to + ': ' + message);\r\n    // if (message.match('bot')) sonia.say(from, \"I heard that!\");\r\n    if (message.match('Sonia: ')||message.match('^!')) {\r\n    // request('http://198.211.99.242:2199/api.php?xm=server.getstatus&f=json&a[username]=json&a[password]=secret', function (error, response, body) {http://198.211.99.242:8020/currentsong?sid=1\r\n        // sonia.action(chan, 'Pokes '+from);\r\n        var begin = message.match('(Sonia: |!)')[1];\r\n        message = message.match('(?:Sonia: |!)(.*)')[1];\r\n        if (message.match('^s(?:ong| |$)')) {\r\n            sonia.say(chan, 'Current Song: '+current.SHOUTCASTSERVER.SONGTITLE);\r\n        } else if (message.match('^l(?:isteners| |$)')) {\r\n            sonia.say(chan, 'Listeners: '+current.SHOUTCASTSERVER.CURRENTLISTENERS);\r\n        } else if (message.match('^lo(?:gin| |$)') && message.match(' (.*)')) {\r\n            sonia.say(chan, \"Last login by \"+message.match(' (.*)')[1]+\": \"+moment(db.getItem(message.match(' (.*)')[1].substring(0,12))).fromNow());\r\n        } else  if (message.match('^\\\\?')) {\r\n            sonia.say(chan,\r\n            'Commands: [s]ong, [l]isteners, [lo]gin, [h]ug, [p]oke, @add, [g]etdata, [n]ext, @[no]tify');\r\n        } else if (message.match('^no(?:tify| |$)')) {\r\n            sonia.whois(from, function (info) {\r\n                if (info.channels.indexOf('@#SonicRadioboom') >= 0 || info.channels.indexOf('~#SonicRadioboom') >= 0 || info.channels.indexOf('%#SonicRadioboom') >= 0) {\r\n                    notify = !notify;\r\n                    sonia.say(chan, 'Notifications '+(notify?'on':'off'));\r\n                } else {\r\n                    console.log(info);\r\n                    sonia.say(from, 'You\\'re not an OP, I don\\'t trust you ...');\r\n                }\r\n            });\r\n\r\n        } else if (message.match('^h(?:ug| |$)')) {\r\n            sonia.action(chan, ' hugs '+from);\r\n        } else if (message.match('^p(?:oke| |$)') && message.match(' (.*)')) {\r\n            sonia.action(chan, ' pokes '+message.match(' (.*)')[1]);\r\n        } else if (message.match('^a(?:dd| |$)') && message.match(' (.*)')) {\r\n            sonia.whois(from, function (info) {\r\n                if (info.channels.indexOf('@#SonicRadioboom') >= 0 || info.channels.indexOf('~#SonicRadioboom') >= 0 || info.channels.indexOf('%#SonicRadioboom') >= 0) {\r\n                    db.setItem(current.SHOUTCASTSERVER.SONGTITLE+\"\", message.match(' (.*)')[1]);\r\n                    sonia.say(from, 'Set record for '+current.SHOUTCASTSERVER.SONGTITLE+' to '+db.getItem(current.SHOUTCASTSERVER.SONGTITLE));\r\n                } else {\r\n                    sonia.say(from, 'You\\'re not an OP, I don\\'t trust you ...');\r\n                }\r\n            });\r\n        } else if (message.match('^s(?:ay| |$)') && message.match(' (.*)')) {\r\n            sonia.whois(from, function (info) {\r\n                if (info.channels.indexOf('@#SonicRadioboom') >= 0 || info.channels.indexOf('~#SonicRadioboom') >= 0 || info.channels.indexOf('%#SonicRadioboom') >= 0) {\r\n                    sonia.say(chan, message.match(' (.*)')[1]);\r\n                } else {\r\n                    sonia.say(from, 'You\\'re not an OP, I don\\'t trust you ...');\r\n                }\r\n            });\r\n        } else if (message.match('^g(?:etdata| |$)')) {\r\n            sonia.say(chan, from+': Does this help? '+current.SHOUTCASTSERVER.SONGTITLE+' is '+db.getItem(current.SHOUTCASTSERVER.SONGTITLE+\"\"));\r\n        } else if (message.match('^n(?:ext| |$)')) {\r\n            googleapis.discover('calendar', 'v3').execute(function(err, client) {\r\n                var moments = message.match(' (.*)');\r\n                if (moments) {\r\n                    moments = moment(moments[1]);\r\n                    moments = moments.isValid()?moments:moment();\r\n                } else {\r\n                    moments = moment();\r\n                }\r\n                var params = {\r\n                      calendarId: 'sonicradioboom2013@gmail.com',\r\n                      maxResults: 1,\r\n                      timeMin: moments,\r\n                      singleEvents: true,\r\n                      orderBy: \"startTime\",\r\n                      };\r\n                client.calendar.events.list(params).withApiKey(key).execute(function (err, response) {\r\n                    response.items.forEach(function (item,a,b) {sonia.say(chan, 'Next event is '+item.summary+' '+moment(item.start.dateTime).fromNow());});\r\n                })});\r\n        } else if (message=='PLEASE QUIT NAO') {\r\n            process.exit();\r\n        } else if (begin!='!') {\r\n            if (to!=config.botName) {\r\n                sonia.say(chan, message+' to you, too, '+from);\r\n            } else {\r\n                sonia.say(from, message+' to you, too, '+from);\r\n            }\r\n        }\r\n    }\r\n});\r\n\r\nsetInterval(function() {\r\n    request(ip+'stats?sid=1', function (error, response, body) {\r\n        if (!error && response.statusCode == 200) {\r\n            parseString(body, function (err, result) {\r\n                if (notify && current && (JSON.stringify(current.SHOUTCASTSERVER.SONGTITLE) != JSON.stringify(result.SHOUTCASTSERVER.SONGTITLE))) {\r\n                    sonia.say(chan, 'New Song: '+result.SHOUTCASTSERVER.SONGTITLE);\r\n                }\r\n                current = result;\r\n            });\r\n        }\r\n    });\r\n}, 1000);\r\n\r\nsonia.addListener('join', function(channel, nick, message) {\r\n    if (channel==chan && nick!=config.botName) {\r\n        sonia.say(chan, 'Hello '+nick+\"!\");\r\n        var record = db.getItem(nick.substring(0,12));\r\n        if (record) {\r\n            sonia.say(chan, 'Welcome back! Last login: '+moment(record).fromNow()+\".\");\r\n            \r\n        } else {\r\n            sonia.say(chan, 'Haven\\'t seen you around before, care to introduce yourself?');\r\n            sonia.say(nick, 'Welcome to #'+chan+'! The radio stream is available at http://thunderlane.ponyvillelive.com/~srb/.');\r\n        }\r\n        db.setItem(nick.substring(0,12), moment());\r\n    }\r\n});\r\n\r\nsonia.addListener('quit', function(channel, nick, message) {\r\n    if (channel==chan && nick!=config.botName) {\r\n        db.setItem(nick.substring(0,12), moment());\r\n    }\r\n});\r\n\r\nsonia.addListener('error', function(message) {\r\n    console.log('error: ', message);\r\n});\r\n"]],"start1":0,"start2":0,"length1":0,"length2":7506}]],"length":7506}
{"contributors":[],"silentsave":false,"ts":1373800904025,"patch":[[{"diffs":[[0,"t event "],[-1,"i"],[1,"start"],[0,"s '+item"]],"start1":5595,"start2":5595,"length1":17,"length2":21}]],"length":7510,"saved":false}
{"ts":1373803504653,"patch":[[{"diffs":[[0,"\n});\r\n\r\n"],[1,"setInterval(function(){client.send('PONG', 'empty');}, 5*60*1000);\r\n\r\n"],[0,"setInter"]],"start1":6032,"start2":6032,"length1":16,"length2":86}]],"length":7580,"saved":false}
{"ts":1373805806342,"patch":[[{"diffs":[[0,"ction(){"],[-1,"client"],[1,"sonia"],[0,".send('P"]],"start1":6055,"start2":6055,"length1":22,"length2":21}]],"length":7579,"saved":false}
{"ts":1373806033024,"patch":[[{"diffs":[[0,"\r\n\r\n"],[-1,"setInterval(function(){sonia.send('PONG', 'empty');}, 5*60*1000);\r\n\r\n"],[0,"setI"]],"start1":6036,"start2":6036,"length1":77,"length2":8}]],"length":7510,"saved":false}
{"contributors":[],"silentsave":false,"ts":1373808903665,"patch":[[{"diffs":[[0,"chan],\r\n"],[-1,"\t"],[1,"    "],[0,"server: "]],"start1":933,"start2":933,"length1":17,"length2":20}]],"length":7513,"saved":false}
{"ts":1373809262462,"patch":[[{"diffs":[[0,"otify = "],[-1,"tru"],[1,"fals"],[0,"e;\r\n\r\n//"]],"start1":1034,"start2":1034,"length1":19,"length2":20}]],"length":7514,"saved":false}
